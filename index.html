import React, { useState, useEffect, useRef } from 'react';
import { 
  Clock, Calendar, History, ChevronLeft, ChevronRight, Sun, Moon, Globe,
  CheckCircle2, Circle, Timer
} from 'lucide-react';

const App = () => {
  // --- State Initialization (LocalStorage) ---
  // GitHub Pages is static, so we use localStorage for persistence.
  
  const [isDark, setIsDark] = useState(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('miruru_isDark');
      return saved !== null ? JSON.parse(saved) : true;
    }
    return true;
  });
  
  const [lang, setLang] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('miruru_lang') || 'en';
    }
    return 'en';
  });

  const [startDate, setStartDate] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('miruru_startDate') || '';
    }
    return '';
  });

  const [timeZoneOffset, setTimeZoneOffset] = useState(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('miruru_timeZoneOffset');
      return saved ? parseInt(saved, 10) : -5;
    }
    return -5;
  });

  const [routineState, setRoutineState] = useState(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('miruru_routineState');
      try {
        return saved ? JSON.parse(saved) : {};
      } catch {
        return {};
      }
    }
    return {};
  });

  const [fullBallsTime, setFullBallsTime] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('miruru_fullBallsTime') || '';
    }
    return '';
  });

  const [currentTime, setCurrentTime] = useState(new Date());
  const [stats, setStats] = useState(null);

  // --- Persistence Effects ---
  // Save to localStorage whenever state changes
  useEffect(() => { localStorage.setItem('miruru_isDark', JSON.stringify(isDark)); }, [isDark]);
  useEffect(() => { localStorage.setItem('miruru_lang', lang); }, [lang]);
  useEffect(() => { localStorage.setItem('miruru_startDate', startDate); }, [startDate]);
  useEffect(() => { localStorage.setItem('miruru_timeZoneOffset', timeZoneOffset.toString()); }, [timeZoneOffset]);
  useEffect(() => { localStorage.setItem('miruru_routineState', JSON.stringify(routineState)); }, [routineState]);
  useEffect(() => { localStorage.setItem('miruru_fullBallsTime', fullBallsTime); }, [fullBallsTime]);


  // --- Logic & Helpers ---

  const [isPickerOpen, setIsPickerOpen] = useState(false);
  const [pickerYear, setPickerYear] = useState(new Date().getFullYear());
  const [pickerMonth, setPickerMonth] = useState(new Date().getMonth());

  const [isTimePickerOpen, setIsTimePickerOpen] = useState(false);
  const [pickerHour, setPickerHour] = useState(new Date().getHours());
  const [pickerMinute, setPickerMinute] = useState(new Date().getMinutes());

  // Translation Dictionary
  const t = {
    en: {
      title: "Miruru's MLB : 9 Innings Tools",
      currentTime: "Current Time",
      accountTracker: "Account Age Tracker",
      creationDate: "Account Creation Date (Server Date)",
      gameTimeZone: "In-game Time Zone",
      selectDate: "Select a date to calculate your total playtime.",
      year: "Year", years: "Years",
      month: "Month", months: "Months",
      week: "Week", weeks: "Weeks",
      day: "Day", days: "Days",
      total: "Total",
      copyright: "Copyright © " + new Date().getFullYear() + " Himemiya Miruru. All rights reserved.",
      monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      monthsLong: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
      weekDays: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
      regions: {
        americas: "America (UTC-5)",
        europe: "Europe (UTC+1)",
        asia: "Asia (UTC+9)"
      },
      routine: {
        title: "Routine Checker",
        fullBallsTime: "Desired Full-Balls Time",
        selectTime: "Set Time",
        league: "League Mode",
        leaguePlay: "League Mode",
        battle: "Battle Mode",
        ranked: "Ranked Battle",
        friend: "Friend Battle",
        special: "Special Mode",
        career: "Career Mode",
        stage: "Stage Challenge",
        arcade: "Arcade Mode",
        clutch: "Clutch Hits Mode",
        club: "Club",
        clubBattle: "Club Battle",
        clubChallenge: "Club Challenge"
      }
    },
    zh: {
      title: "Miruru's MLB : 9 Innings 工具",
      currentTime: "當前時間",
      accountTracker: "帳號年資追蹤器",
      creationDate: "帳號創建日期 (伺服器日期)",
      gameTimeZone: "遊戲內時區",
      selectDate: "請選擇日期以計算總遊玩時間",
      year: "年", years: "年",
      month: "個月", months: "個月",
      week: "週", weeks: "週",
      day: "天", days: "天",
      total: "總計",
      copyright: "Copyright © " + new Date().getFullYear() + " 姬宮みるる 版權所有",
      monthsShort: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
      monthsLong: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
      weekDays: ['日', '一', '二', '三', '四', '五', '六'],
      regions: {
        americas: "美洲 (UTC-5)",
        europe: "歐洲 (UTC+1)",
        asia: "亞洲 (UTC+9)"
      },
      routine: {
        title: "每日例行檢查",
        fullBallsTime: "預定滿球時間",
        selectTime: "設定時間",
        league: "聯賽模式",
        leaguePlay: "聯賽模式",
        battle: "對戰模式",
        ranked: "排名戰",
        friend: "好友對戰",
        special: "特別模式",
        career: "職業模式",
        stage: "關卡挑戰",
        arcade: "競技模式",
        clutch: "打點模式",
        club: "俱樂部",
        clubBattle: "俱樂部戰",
        clubChallenge: "俱樂部挑戰"
      }
    }
  };

  const currentT = t[lang];

  const routineStructure = [
    {
      id: 'league',
      titleKey: 'league',
      items: [
        { id: 'league_play', labelKey: 'leaguePlay' }
      ]
    },
    {
      id: 'battle',
      titleKey: 'battle',
      items: [
        { id: 'ranked_battle', labelKey: 'ranked' },
        { id: 'friend_battle', labelKey: 'friend' }
      ]
    },
    {
      id: 'special',
      titleKey: 'special',
      items: [
        { id: 'career_mode', labelKey: 'career' },
        { id: 'stage_challenge', labelKey: 'stage' },
        { id: 'arcade_mode', labelKey: 'arcade' },
        { id: 'clutch_hits', labelKey: 'clutch' }
      ]
    },
    {
      id: 'club',
      titleKey: 'club',
      items: [
        { id: 'club_battle', labelKey: 'clubBattle' },
        { id: 'club_challenge', labelKey: 'clubChallenge' }
      ]
    }
  ];

  // Effect to handle the live clock
  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(new Date());
    }, 1000);
    return () => clearInterval(timer);
  }, []);

  // Effect to calculate duration
  useEffect(() => {
    if (startDate) {
      calculateDuration(startDate, timeZoneOffset);
    }
  }, [startDate, currentTime, timeZoneOffset]);

  const calculateDuration = (start, offset) => {
    const [y, m, d] = start.split('-').map(Number);
    const utcMidnight = Date.UTC(y, m - 1, d, 0, 0, 0);
    const startTimestamp = utcMidnight - (offset * 60 * 60 * 1000);
    const nowTimestamp = new Date().getTime();

    if (startTimestamp > nowTimestamp) {
      setStats(null);
      return;
    }

    const diffTime = Math.abs(nowTimestamp - startTimestamp);
    const rawDaysDiff = diffTime / (1000 * 60 * 60 * 24);
    const totalDays = rawDaysDiff + 1;

    const years = totalDays / 365.25;
    const months = totalDays / 30.4375;
    const weeks = totalDays / 7;
    const days = totalDays;

    setStats({
      years: years.toFixed(2),
      months: months.toFixed(1),
      weeks: weeks.toFixed(0),
      days: Math.floor(days).toLocaleString(),
      rawDays: days 
    });
  };

  const toggleRoutineItem = (id) => {
    setRoutineState(prev => ({
      ...prev,
      [id]: !prev[id]
    }));
  };

  // --- Custom Date Picker Logic ---
  const daysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
  const firstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();

  const handleDayClick = (day) => {
    const formattedMonth = String(pickerMonth + 1).padStart(2, '0');
    const formattedDay = String(day).padStart(2, '0');
    const dateStr = `${pickerYear}-${formattedMonth}-${formattedDay}`;
    setStartDate(dateStr);
    setIsPickerOpen(false);
  };

  const openPicker = () => {
    if (startDate) {
      const [y, m, d] = startDate.split('-').map(Number);
      setPickerYear(y);
      setPickerMonth(m - 1);
    } else {
      const now = new Date();
      setPickerYear(now.getFullYear());
      setPickerMonth(now.getMonth());
    }
    setIsPickerOpen(true);
  };

  const closePicker = (e) => {
    e.stopPropagation();
    setIsPickerOpen(false);
  };

  const changeMonth = (offset) => {
    let newMonth = pickerMonth + offset;
    let newYear = pickerYear;
    if (newMonth < 0) { newMonth = 11; newYear -= 1; } 
    else if (newMonth > 11) { newMonth = 0; newYear += 1; }
    if (newYear < 2016) return;
    setPickerMonth(newMonth);
    setPickerYear(newYear);
  };

  const handleYearChange = (e) => setPickerYear(parseInt(e.target.value));
  const handleMonthChange = (e) => setPickerMonth(parseInt(e.target.value));
  const handleTimeZoneChange = (e) => setTimeZoneOffset(parseInt(e.target.value));

  // --- Custom Time Picker Logic ---
  const openTimePicker = () => {
    if (fullBallsTime) {
      const [h, m] = fullBallsTime.split(':').map(Number);
      setPickerHour(h);
      setPickerMinute(m);
    } else {
      const now = new Date();
      setPickerHour(now.getHours());
      setPickerMinute(now.getMinutes());
    }
    setIsTimePickerOpen(true);
  };

  const closeTimePicker = (e) => {
    e.stopPropagation();
    setIsTimePickerOpen(false);
  };

  const handleHourChange = (e) => {
    const h = parseInt(e.target.value);
    setPickerHour(h);
    updateFullBallsTime(h, pickerMinute);
  };

  const handleMinuteChange = (e) => {
    const m = parseInt(e.target.value);
    setPickerMinute(m);
    updateFullBallsTime(pickerHour, m);
  };

  const updateFullBallsTime = (h, m) => {
    setFullBallsTime(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
  };

  const getDisplayDate = (dateString) => {
    if (!dateString) return '';
    const [y, m, d] = dateString.split('-');
    return `${m}/${d}/${y}`;
  };

  const getLabel = (valString, type) => {
    if (!valString) return `${currentT.total} ${currentT[type + 's']}`;
    if (lang === 'zh') return `${currentT.total} ${currentT[type]}`;
    const val = parseFloat(valString.toString().replace(/,/g, ''));
    return val <= 1 ? `${currentT.total} ${currentT[type]}` : `${currentT.total} ${currentT[type + 's']}`;
  };

  const getUnit = (valString, type) => {
    if (lang === 'zh') return currentT[type];
    if (!valString) return currentT[type + 's'];
    const val = parseFloat(valString.toString().replace(/,/g, ''));
    return val <= 1 ? currentT[type] : currentT[type + 's'];
  }

  const currentYear = new Date().getFullYear();
  const yearsRange = Array.from({ length: currentYear - 2015 }, (_, i) => currentYear - i);
  const hoursRange = Array.from({ length: 24 }, (_, i) => i);
  const minutesRange = Array.from({ length: 60 }, (_, i) => i);

  const toggleTheme = () => setIsDark(!isDark);
  const toggleLanguage = () => setLang(prev => prev === 'en' ? 'zh' : 'en');

  return (
    <div className={isDark ? 'dark' : ''}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        .font-noto { font-family: 'Noto Sans', 'Noto Sans TC', sans-serif; }
      `}</style>

      <div className="min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-noto selection:bg-blue-500 selection:text-white flex flex-col items-center relative transition-colors duration-300">
        
        {/* Header */}
        <header className="fixed top-0 left-0 w-full z-50 bg-slate-100/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 transition-colors duration-300 shadow-sm">
            <div className="max-w-5xl mx-auto px-4 h-20 flex items-center justify-center relative">
                 <h1 className="text-xl md:text-3xl font-bold tracking-wider text-blue-600 dark:text-blue-400 drop-shadow-sm transition-colors duration-300 text-center truncate px-12 md:px-0">
                    {currentT.title}
                 </h1>
                <div className="absolute right-4 flex space-x-2">
                    <button onClick={toggleTheme} className="p-2 rounded-full transition-colors duration-200 shadow-md border bg-white border-slate-200 text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-white">
                        {isDark ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                    </button>
                    <button onClick={toggleLanguage} className="p-2 rounded-full transition-colors duration-200 shadow-md border bg-white border-slate-200 text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-white font-bold text-xs w-9 h-9 flex items-center justify-center">
                        {lang === 'en' ? '中' : 'EN'}
                    </button>
                </div>
            </div>
        </header>

        {/* Content */}
        <div className="max-w-5xl w-full px-4 flex flex-col gap-10 pt-28 pb-12 animate-in fade-in duration-700">
          
          {/* Current Time Section */}
          <section className="bg-white dark:bg-slate-800 rounded-2xl p-10 shadow-xl border border-slate-200 dark:border-slate-700 relative overflow-hidden min-h-[200px] flex flex-col justify-center w-full transition-colors duration-300">
            <div className="absolute -top-6 -right-6 p-4 opacity-5 pointer-events-none">
              <Clock size={180} />
            </div>
            <div className="relative z-10 text-center md:text-left space-y-4">
              <h2 className="text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wider flex items-center justify-center md:justify-start gap-2">
                {currentT.currentTime}
              </h2>
              <div className="text-5xl md:text-7xl font-bold font-mono text-blue-600 dark:text-blue-400 tracking-wider transition-colors duration-300">
                {currentTime.toLocaleTimeString([], { hour12: false })}
              </div>
              <div className="text-xl text-slate-500 dark:text-slate-400 font-medium md:ml-1">
                {currentTime.toLocaleDateString(lang === 'zh' ? 'zh-TW' : 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </div>
            </div>
          </section>

          {/* Account Age Calculator Section */}
          <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-xl border border-slate-200 dark:border-slate-700 w-full relative transition-colors duration-300">
            <div className="mb-8 w-full">
              <div className="flex items-center gap-3 border-b border-slate-200 dark:border-slate-700 pb-4 mb-6">
                <History className="text-blue-600 dark:text-blue-500 w-8 h-8 transition-colors duration-300" />
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white transition-colors duration-300">{currentT.accountTracker}</h2>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Date Input */}
                <div>
                  <label className="block text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wider mb-3 transition-colors duration-300">
                    {currentT.creationDate}
                  </label>
                  <div className="relative w-full h-14">
                    <div className={`block w-full h-full pl-14 pr-4 bg-slate-50 dark:bg-slate-900 border ${isPickerOpen ? 'border-blue-500 ring-2 ring-blue-500' : 'border-slate-300 dark:border-slate-600'} rounded-xl text-lg flex items-center cursor-pointer hover:border-blue-400 transition-all`} onClick={openPicker}>
                       <div className="absolute inset-y-0 left-0 w-14 flex items-center justify-center pointer-events-none">
                          <Calendar className={`h-6 w-6 ${isPickerOpen ? 'text-blue-600 dark:text-blue-500' : 'text-slate-400'}`} />
                       </div>
                       {startDate ? (
                          <span className="text-slate-900 dark:text-white">{getDisplayDate(startDate)}</span>
                       ) : (
                          <span className="text-slate-500 text-base">{currentT.selectDate}</span>
                       )}
                    </div>
                    {/* Date Picker (Included Inline) */}
                    {isPickerOpen && (
                      <>
                        <div className="fixed inset-0 z-40" onClick={closePicker}></div>
                        <div className="absolute top-full left-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl shadow-2xl z-50 p-4 w-full md:w-80 animate-in fade-in zoom-in-95 duration-200 font-noto">
                          <div className="flex items-center justify-between mb-4 gap-2">
                             <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-500 dark:text-slate-300 transition-colors"><ChevronLeft size={20} /></button>
                             <div className="flex gap-2 flex-1 justify-center">
                               <select value={pickerMonth} onChange={handleMonthChange} className="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:outline-none focus:border-blue-500 font-noto">{currentT.monthsLong.map((m, i) => (<option key={m} value={i}>{m}</option>))}</select>
                               <select value={pickerYear} onChange={handleYearChange} className="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white text-sm border border-slate-300 dark:border-slate-600 rounded px-2 py-1 focus:outline-none focus:border-blue-500 font-noto">{yearsRange.map(year => (<option key={year} value={year}>{year}</option>))}</select>
                             </div>
                             <button onClick={() => changeMonth(1)} className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full text-slate-500 dark:text-slate-300 transition-colors"><ChevronRight size={20} /></button>
                          </div>
                          <div className="grid grid-cols-7 mb-2 text-center">{currentT.weekDays.map(d => (<div key={d} className="text-xs font-bold text-slate-500 dark:text-slate-500">{d}</div>))}</div>
                          <div className="grid grid-cols-7 gap-1">
                            {Array.from({ length: firstDayOfMonth(pickerMonth, pickerYear) }).map((_, i) => (<div key={`empty-${i}`} className="h-8 md:h-9"></div>))}
                            {Array.from({ length: daysInMonth(pickerMonth, pickerYear) }).map((_, i) => {
                              const day = i + 1;
                              const isSelected = startDate === `${pickerYear}-${String(pickerMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                              const isToday = new Date().getDate() === day && new Date().getMonth() === pickerMonth && new Date().getFullYear() === pickerYear;
                              return (
                                <button key={day} onClick={() => handleDayClick(day)} className={`h-8 md:h-9 w-full rounded-md text-sm font-medium transition-all ${isSelected ? 'bg-blue-600 text-white shadow-md' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-white'} ${isToday && !isSelected ? 'border border-blue-500/50 text-blue-600 dark:text-blue-400' : ''}`}>{day}</button>
                              );
                            })}
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
                {/* Time Zone Input */}
                <div>
                  <label className="block text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wider mb-3 transition-colors duration-300">
                    {currentT.gameTimeZone}
                  </label>
                  <div className="relative w-full h-14">
                    <div className="absolute inset-y-0 left-0 w-14 flex items-center justify-center pointer-events-none z-10">
                      <Globe className="h-6 w-6 text-slate-400" />
                    </div>
                    <select value={timeZoneOffset} onChange={handleTimeZoneChange} className="block w-full h-full pl-14 pr-4 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-xl text-lg text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer appearance-none transition-colors">
                      <option value="-5">{currentT.regions.americas}</option>
                      <option value="1">{currentT.regions.europe}</option>
                      <option value="9">{currentT.regions.asia}</option>
                    </select>
                    <div className="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                      <svg className="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fillRule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Stats Grid */}
            {startDate && stats ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500 pt-4 border-t border-slate-200 dark:border-slate-700/50 w-full transition-colors duration-300">
                <div className="bg-white dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-lg hover:border-blue-500/50 transition-colors group flex flex-col justify-center min-h-[160px] min-w-0">
                  <div className="flex items-center justify-between mb-4"><span className="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-widest">{getUnit(stats.years, 'year')}</span></div>
                  <div className="text-4xl font-bold text-slate-900 dark:text-white mb-2 font-mono">{stats.years}</div>
                  <div className="text-sm text-slate-500">{getLabel(stats.years, 'year')}</div>
                </div>
                <div className="bg-white dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-lg hover:border-blue-500/50 transition-colors group flex flex-col justify-center min-h-[160px] min-w-0">
                  <div className="flex items-center justify-between mb-4"><span className="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-widest">{getUnit(stats.months, 'month')}</span></div>
                  <div className="text-4xl font-bold text-slate-900 dark:text-white mb-2 font-mono">{stats.months}</div>
                  <div className="text-sm text-slate-500">{getLabel(stats.months, 'month')}</div>
                </div>
                <div className="bg-white dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-lg hover:border-blue-500/50 transition-colors group flex flex-col justify-center min-h-[160px] min-w-0">
                  <div className="flex items-center justify-between mb-4"><span className="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-widest">{getUnit(stats.weeks, 'week')}</span></div>
                  <div className="text-4xl font-bold text-slate-900 dark:text-white mb-2 font-mono">{stats.weeks}</div>
                  <div className="text-sm text-slate-500">{getLabel(stats.weeks, 'week')}</div>
                </div>
                <div className="bg-white dark:bg-slate-900/80 border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-lg hover:border-blue-500/50 transition-colors group flex flex-col justify-center min-h-[160px] min-w-0">
                  <div className="flex items-center justify-between mb-4"><span className="text-slate-500 dark:text-slate-400 text-sm font-bold uppercase tracking-widest">{getUnit(stats.days.replace(/,/g, ''), 'day')}</span></div>
                  <div className="text-4xl font-bold text-slate-900 dark:text-white mb-2 font-mono">{stats.days}</div>
                  <div className="text-sm text-slate-500">{getLabel(stats.days.replace(/,/g, ''), 'day')}</div>
                </div>
              </div>
            ) : (
               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 pt-4 border-t border-transparent w-full h-0 overflow-hidden invisible"><div className="min-w-0"></div><div className="min-w-0"></div><div className="min-w-0"></div><div className="min-w-0"></div></div>
            )}
            {startDate && !stats && (
               <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 p-6 rounded-xl text-red-600 dark:text-red-200 text-center mt-6">
                  {lang === 'en' ? "Invalid date selected. Please choose a date in the past." : "選擇的日期無效，請選擇過去的日期。"}
               </div>
            )}
          </section>

          {/* Routine Checker Section */}
          <section className="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-xl border border-slate-200 dark:border-slate-700 w-full relative transition-colors duration-300">
            <div className="flex items-center gap-3 border-b border-slate-200 dark:border-slate-700 pb-4 mb-6">
              <CheckCircle2 className="text-green-600 dark:text-green-500 w-8 h-8 transition-colors duration-300" />
              <h2 className="text-2xl font-bold text-slate-900 dark:text-white transition-colors duration-300">{currentT.routine.title}</h2>
            </div>

            {/* Custom Time Picker for "Desired Full-Balls Time" */}
            <div className="mb-6">
              <label className="block text-slate-500 dark:text-slate-400 text-sm font-semibold uppercase tracking-wider mb-3 transition-colors duration-300">
                {currentT.routine.fullBallsTime}
              </label>
              <div className="relative w-full md:w-1/2 h-14">
                <div 
                  className={`block w-full h-full pl-14 pr-4 bg-slate-50 dark:bg-slate-900 border ${isTimePickerOpen ? 'border-blue-500 ring-2 ring-blue-500' : 'border-slate-300 dark:border-slate-600'} rounded-xl text-lg flex items-center cursor-pointer hover:border-blue-400 transition-all`}
                  onClick={openTimePicker}
                >
                   <div className="absolute inset-y-0 left-0 w-14 flex items-center justify-center pointer-events-none">
                      <Timer className={`h-6 w-6 ${isTimePickerOpen ? 'text-blue-600 dark:text-blue-500' : 'text-slate-400'}`} />
                   </div>
                   {fullBallsTime ? (
                      <span className="text-slate-900 dark:text-white">{fullBallsTime}</span>
                   ) : (
                      <span className="text-slate-500 text-base">{currentT.routine.selectTime}</span>
                   )}
                </div>

                {/* Time Picker Popup */}
                {isTimePickerOpen && (
                  <>
                    <div className="fixed inset-0 z-40" onClick={closeTimePicker}></div>
                    <div className="absolute top-full left-0 mt-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded-xl shadow-2xl z-50 p-4 w-full animate-in fade-in zoom-in-95 duration-200 font-noto">
                      <div className="flex gap-4 justify-center">
                        {/* Hour */}
                        <div className="flex flex-col items-center">
                          <label className="text-xs text-slate-500 dark:text-slate-400 mb-1 font-bold">Hour</label>
                          <select 
                            value={pickerHour} 
                            onChange={handleHourChange}
                            className="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white text-lg border border-slate-300 dark:border-slate-600 rounded px-2 py-2 w-20 focus:outline-none focus:border-blue-500 font-noto text-center"
                          >
                            {hoursRange.map(h => (
                              <option key={h} value={h}>{String(h).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                        <div className="flex items-center pt-5 text-slate-400 font-bold">:</div>
                        {/* Minute */}
                        <div className="flex flex-col items-center">
                          <label className="text-xs text-slate-500 dark:text-slate-400 mb-1 font-bold">Min</label>
                          <select 
                            value={pickerMinute} 
                            onChange={handleMinuteChange}
                            className="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-white text-lg border border-slate-300 dark:border-slate-600 rounded px-2 py-2 w-20 focus:outline-none focus:border-blue-500 font-noto text-center"
                          >
                            {minutesRange.map(m => (
                              <option key={m} value={m}>{String(m).padStart(2, '0')}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                  </>
                )}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {routineStructure.map((section) => {
                return (
                  <div key={section.id} className="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-5 border border-slate-200 dark:border-slate-700/50">
                    <div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-200 dark:border-slate-700/50">
                      <h3 className="font-bold text-slate-700 dark:text-slate-200">{currentT.routine[section.titleKey]}</h3>
                    </div>
                    <div className="space-y-3">
                      {section.items.map((item) => {
                        const isChecked = routineState[item.id] || false;
                        return (
                          <button
                            key={item.id}
                            onClick={() => toggleRoutineItem(item.id)}
                            className={`w-full flex items-center justify-between p-3 rounded-lg border transition-all duration-200 ${
                              isChecked 
                                ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800' 
                                : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:border-blue-400 dark:hover:border-blue-500'
                            }`}
                          >
                            <span className={`text-sm font-medium ${isChecked ? 'text-blue-700 dark:text-blue-300' : 'text-slate-600 dark:text-slate-400'}`}>
                              {currentT.routine[item.labelKey]}
                            </span>
                            {isChecked ? (
                              <CheckCircle2 className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                            ) : (
                              <Circle className="w-5 h-5 text-slate-300 dark:text-slate-600" />
                            )}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          </section>

        </div>

        {/* Footer */}
        <div className="absolute bottom-4 w-full text-center text-[10px] text-slate-500 dark:text-slate-600 pointer-events-none font-noto">
           {currentT.copyright}
        </div>
      </div>
    </div>
  );
};

export default App;